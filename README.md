# example_dashboard2

v
"""MFAChecker class utilizing aws cli to confirm user mfa is enabled."""
import json
import os
import datetime
import logging
import subprocess


logging.basicConfig(
    format='%(levelname)s:%(message)s',
    level=logging.INFO
    )
LOGGER = logging.getLogger('mfa_check_logger')


class MFAChecker:
    """AWS cli client to check account users mfa enabled status."""
    def __init__(self):
        self.active_users = []
        self.mfa_users = []
        self.non_mfa_users = []
        self.report_folder_name = 'mfa_reports'
        self.users_report = 'users.json'
        self.vmfa_report = 'users_vmfa_report.json'
        self.summary_user_report = 'summary_user_mfa_report.json'
    
    def create_report_folder(self):
        """Creates folder to hold reports generated by cloudtrail api queries"""
        try:
            cwd = os.getcwd()
            folder_path = f'{cwd}/{self.report_folder_name}'
            os.mkdir(folder_path)
        except Exception as error:
            return error

    def create_user_report(self):
        try:
            cwd = os.getcwd()
            folder_path = f'{cwd}/{self.report_folder_name}'
            cmd = f'aws iam list-users > {folder_path}/{self.users_report}'
            subprocess.call(cmd, shell=True)
            LOGGER.info(f'Status: reating account user list report')
        except Exception as error:
            info = {
                'message': 'Could not create bucket list report',
                'error': error
            }
            return info

    def create_vmfa_report(self):
        try:
            cwd = os.getcwd()
            folder_path = f'{cwd}/{self.report_folder_name}'
            cmd = f'aws iam list-virtual-mfa-devices  > {folder_path}/{self.vmfa_report}'
            subprocess.call(cmd, shell=True)
            LOGGER.info(f'Status: Creating virtual mfa device report')
        except Exception as error:
            info = {
                'message': 'Could not create bucket list report',
                'error': error
            }
            return info

    def get_all_users(self):
        """Returns list of all account user names."""
        file_name = f'{self.report_folder_name}/{self.users_report}'
        with open(file_name) as f:
            user_info = json.load(f)
            all_users = user_info['Users']
            for user in all_users:
                self.active_users.append(user['UserName'])
        return self.active_users

    def check_mfa_status_all(self):
        """Returns list of user's with enabled virtual mfa devices."""
        try:
            LOGGER.info(f'Status: Reviewing mfa status for all users')
            file_name = f'{self.report_folder_name}/{self.vmfa_report}'
            with open(file_name) as f:
                all_devices = json.load(f)
                all_user_devices = all_devices['VirtualMFADevices']
                for device in all_user_devices:
                    username = device['User']['UserName']
                    if 'EnableDate' in device:
                        self.mfa_users.append(username)
                
                return self.mfa_users
        except Exception as error:
            LOGGER.info(f'Status: Could not review user mfa report.')
            info = {
                 'message': 'Could not review user mfa report.',
                 'error': error
             }
            return info

    def create_summary_report(self):
        LOGGER.info(f'Status: Creating summary user mfa report.')
        users = self.get_all_users()
        mfa_users = self.check_mfa_status_all()
        if 'error' not in mfa_users:
            for user in users:
                if user not in mfa_users:
                    self.non_mfa_users.append(user)

            summary_info = {
                'total_users': len(users),
                'total_mfa_users': len(mfa_users),
                'active_users': users,
                'mfa_users': mfa_users,
                'non-mfa_users': self.non_mfa_users
            }
            print(summary_info)
            with open(self.summary_user_report, 'w') as f:
                json.dump(summary_info, f)

        if 'error' in mfa_users:
            summary_info = {
                'error': mfa_users['error'],
                'message': 'Could not generate summary user mfa report.'
            }
            with open(self.summary_user_report, 'w') as f:
                json.dump(summary_info, f)

# Sample run
# mfa = MFAChecker()
# mfa.create_summary_report()


---
import json
import os
import subprocess
from unittest import TestCase

from mfa_check import MFAChecker

class MFACheckerTestCase(TestCase):
    def setUp(self):
        mfa = MFAChecker()

    def test_init(self):
        self.assertIsNotNone(self.mfa.active_users)
        self.assertIsNotNone(self.mfa.mfa_users)
        self.assertIsNotNone(self.mfa.non_mfa_users)

    def test_create_report_folder(self):
        folder_name = 'mfa_reports'
        folder_check = os.path.isdir(folder_name)
        self.assertTrue(folder_check)

    def test_create_user_report(self):
        cwd = os.getcwd()
        file_path = f'{cwd}/{self.mfa.report_folder_name}/{self.mfa.users_report}'
        folder_check = os.path.isfile(folder_check)
        self.assertTrue(folder_check)

    def test_create_vmfa_report(self):
        cwd = os.getcwd()
        file_path = f'{cwd}/{self.mfa.report_folder_name}/{self.mfa.vmfa_report}'
        folder_check = os.path.isfile(folder_check)
        self.assertTrue(folder_check)
